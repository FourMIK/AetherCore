name: "Operation Ironclad: Desktop Release"

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build Desktop App (${{ matrix.platform }})
    timeout-minutes: 90
    permissions:
      contents: write
      attestations: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            os: macos-latest
            artifact_glob: "packages/dashboard/src-tauri/target/release/bundle/**/*.dmg"
            tauri_args: "--target universal-apple-darwin"
          - platform: windows
            os: windows-latest
            artifact_glob: "packages/dashboard/src-tauri/target/release/bundle/**/*.msi"
            tauri_args: ""

    runs-on: ${{ matrix.os }}

    env:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
      WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
      WINDOWS_SIGNING_TIMESTAMP_URL: ${{ secrets.WINDOWS_SIGNING_TIMESTAMP_URL }}
      CHECKSUM_SIGNING_PRIVATE_KEY: ${{ secrets.CHECKSUM_SIGNING_PRIVATE_KEY }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check required network endpoints
        run: ./scripts/check-network-prereqs.sh

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          targets: ${{ matrix.platform == 'windows' && 'x86_64-pc-windows-msvc' || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache Rust Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-desktop-
            ${{ runner.os }}-cargo-

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            */*/node_modules
            packages/*/node_modules
            services/*/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Dependencies (macOS)
        if: matrix.platform == 'macos'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Enable Corepack
        run: corepack enable

      - name: Install npm Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run environment checks
        run: pnpm doctor

      - name: "ðŸ›¡ï¸ Operation Ironclad: Comprehensive Release Checklist"
        run: |
          chmod +x ./scripts/release-checklist.sh
          ./scripts/release-checklist.sh

      - name: Enforce signing and notarization secrets (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          required=(APPLE_CERTIFICATE APPLE_CERTIFICATE_PASSWORD APPLE_SIGNING_IDENTITY APPLE_ID APPLE_PASSWORD APPLE_TEAM_ID CHECKSUM_SIGNING_PRIVATE_KEY)
          for key in "${required[@]}"; do
            if [ -z "${!key}" ]; then
              echo "âŒ Missing required secret: $key"
              exit 1
            fi
          done

      - name: Enforce signing secrets (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $required = @('WINDOWS_CERTIFICATE', 'WINDOWS_CERTIFICATE_PASSWORD', 'CHECKSUM_SIGNING_PRIVATE_KEY', 'WINDOWS_SIGNING_TIMESTAMP_URL')
          foreach ($key in $required) {
            $value = (Get-Item -Path "Env:$key" -ErrorAction SilentlyContinue).Value
            if ([string]::IsNullOrWhiteSpace($value)) {
              throw "Missing required secret: $key"
            }
          }

      - name: Build Frontend (TypeScript)
        run: |
          cd packages/dashboard
          pnpm run build

      - name: Build & Package Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: "./packages/dashboard"
          tagName: ${{ github.ref_name }}
          releaseName: "AetherCore Tactical Glass ${{ github.ref_name }}"
          releaseBody: |
            ## AetherCore Tactical Glass Release ${{ github.ref_name }}

            ### Desktop Applications
            - **Windows**: Authenticode signed installer + trusted RFC3161 timestamp
            - **macOS**: Developer ID signed, notarized, and stapled universal DMG

            ### Security Notes
            - Release checksums are cryptographically signed
            - SBOM and provenance attestations are attached to every release

            ### Installation
            See [INSTALLATION.md](https://github.com/FourMIK/AetherCore/blob/main/INSTALLATION.md).
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.tauri_args }}

      - name: "Gate: verify macOS code signing + notarization + stapling"
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euo pipefail
          dmg="$(find packages/dashboard/src-tauri/target/release/bundle -name '*.dmg' | head -n 1)"
          app="$(find packages/dashboard/src-tauri/target/release/bundle -name '*.app' | head -n 1)"

          test -n "$dmg" && test -n "$app"

          codesign --verify --deep --strict --verbose=4 "$app"
          spctl --assess --type execute --verbose=4 "$app"
          xcrun stapler validate "$dmg"

      - name: "Gate: verify Windows Authenticode + trusted timestamp"
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "packages/dashboard/src-tauri/target/release/bundle" -Recurse -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "No MSI artifact found" }

          $signtool = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Sort-Object FullName -Descending |
            Select-Object -First 1
          if (-not $signtool) { throw "signtool.exe not found" }

          & $signtool.FullName verify /pa /tw /v $msi.FullName
          if ($LASTEXITCODE -ne 0) { throw "Authenticode or timestamp verification failed" }

      - name: "Validation Gate: install + launch + bootstrap ready (macOS)"
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euo pipefail
          dmg="$(find packages/dashboard/src-tauri/target/release/bundle -name '*.dmg' | head -n 1)"
          mount_dir="$(mktemp -d)"
          hdiutil attach "$dmg" -mountpoint "$mount_dir"
          app_path="$(find "$mount_dir" -maxdepth 1 -name '*.app' | head -n 1)"
          cp -R "$app_path" /Applications/
          hdiutil detach "$mount_dir"

          APP_BIN="/Applications/$(basename "$app_path")/Contents/MacOS/$(basename "$app_path" .app)"
          AETHERCORE_SKIP_SENTINEL_FOR_CI=1 CI=1 "$APP_BIN" --bootstrap > /tmp/aethercore-macos-launch.log 2>&1 &
          APP_PID=$!
          sleep 25
          kill "$APP_PID" || true

          CONFIG_FILE="$HOME/Library/Application Support/com.aethercore.tactical-glass-dev/runtime-config.json"
          test -f "$CONFIG_FILE"

      - name: "Validation Gate: install + launch + bootstrap ready (Windows)"
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "packages/dashboard/src-tauri/target/release/bundle" -Recurse -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "No MSI artifact found" }

          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /norestart" -Wait -NoNewWindow

          $exe = Get-ChildItem -Path "$env:LOCALAPPDATA\Programs" -Recurse -Filter "*.exe" |
            Where-Object { $_.Name -like "*Tactical*" -or $_.Name -like "*aethercore*" } |
            Select-Object -First 1
          if (-not $exe) { throw "Installed executable not found" }

          $launch = Start-Process -FilePath $exe.FullName -ArgumentList "--bootstrap" -PassThru -Environment @{
            CI = '1'
            AETHERCORE_SKIP_SENTINEL_FOR_CI = '1'
          }
          Start-Sleep -Seconds 25
          if (-not $launch.HasExited) { Stop-Process -Id $launch.Id -Force }

          $configPath = Join-Path $env:APPDATA "com.aethercore.tactical-glass-dev\runtime-config.json"
          if (-not (Test-Path $configPath)) {
            throw "Bootstrap ready-state config not found at $configPath"
          }

      - name: Build checksum + signature + provenance bundle
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-artifacts

          checksum_file="release-artifacts/SHA256SUMS-${{ matrix.platform }}.txt"
          signature_file="${checksum_file}.sig"

          while IFS= read -r -d '' file; do
            shasum -a 256 "$file" >> "$checksum_file"
          done < <(find packages/dashboard/src-tauri/target/release/bundle -type f \( -name '*.dmg' -o -name '*.msi' -o -name '*.app' -o -name '*.exe' \) -print0)

          printf '%s' "$CHECKSUM_SIGNING_PRIVATE_KEY" > release-artifacts/checksum-signing.pem
          openssl dgst -sha256 -sign release-artifacts/checksum-signing.pem -out "$signature_file" "$checksum_file"
          rm -f release-artifacts/checksum-signing.pem

          cat > "release-artifacts/provenance-${{ matrix.platform }}.json" <<EOF
          {
            "tag": "${{ github.ref_name }}",
            "platform": "${{ matrix.platform }}",
            "commit": "${{ github.sha }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "signed_checksums": "$(basename "$signature_file")"
          }
          EOF

      - name: Upload signed checksum + provenance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-integrity-${{ matrix.platform }}
          path: |
            release-artifacts/SHA256SUMS-${{ matrix.platform }}.txt
            release-artifacts/SHA256SUMS-${{ matrix.platform }}.txt.sig
            release-artifacts/provenance-${{ matrix.platform }}.json
          if-no-files-found: error
          retention-days: 90

      - name: Generate build provenance attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ${{ matrix.artifact_glob }}

      - name: Attach integrity + provenance assets to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/SHA256SUMS-${{ matrix.platform }}.txt
            release-artifacts/SHA256SUMS-${{ matrix.platform }}.txt.sig
            release-artifacts/provenance-${{ matrix.platform }}.json
            sbom-artifacts/tauri-sbom.json
            sbom-artifacts/frontend-sbom.json
            sbom-artifacts/LICENSE_MANIFEST.txt
            sbom-artifacts/SUPPLY_CHAIN_MANIFEST.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
