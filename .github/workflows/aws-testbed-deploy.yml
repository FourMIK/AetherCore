name: AWS Testbed Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: Docker image tag to build, push, and deploy
        required: true
        type: string
      aws_region:
        description: AWS region for ECR/ECS/Terraform
        required: true
        default: us-east-1
        type: string
      project_name:
        description: Project name prefix used by infra/scripts/build-push.sh
        required: true
        default: aethercore
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  build_and_plan:
    name: Build images and Terraform plan
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      PROJECT_NAME: ${{ inputs.project_name }}
      IMAGE_TAG: ${{ inputs.image_tag }}
      TF_WORKING_DIR: infra/terraform/environments/aws-testbed
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TESTBED_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and push container images
        run: |
          chmod +x infra/scripts/build-push.sh
          infra/scripts/build-push.sh "$AWS_REGION" "$PROJECT_NAME" "$IMAGE_TAG"

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -backend-config=backend.hcl

      - name: Terraform plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -out=tfplan -var="image_tag=$IMAGE_TAG"

      - name: Upload Terraform plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws-testbed-tfplan
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          if-no-files-found: error

  apply:
    name: Terraform apply (approved)
    runs-on: ubuntu-latest
    needs: build_and_plan
    environment: aws-testbed
    env:
      AWS_REGION: ${{ inputs.aws_region }}
      IMAGE_TAG: ${{ inputs.image_tag }}
      TF_WORKING_DIR: infra/terraform/environments/aws-testbed
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TESTBED_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Terraform plan artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-testbed-tfplan
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -backend-config=backend.hcl

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Publish deployment outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          {
            echo "## AWS Testbed Deployment Outputs"
            echo
            echo "- **Image Tag**: \\`$IMAGE_TAG\\`"
            echo "- **ALB DNS Name**: \\`$(terraform output -raw alb_dns_name)\\`"
            echo "- **Gateway Service**: \\`$(terraform output -raw gateway_service_name)\\`"
            echo "- **Auth Service**: \\`$(terraform output -raw auth_service_name)\\`"
            echo "- **Collaboration Service**: \\`$(terraform output -raw collaboration_service_name)\\`"
            echo "- **H2-Ingest Service**: \\`$(terraform output -raw h2_ingest_service_name)\\`"
            echo "- **Prometheus Service**: \\`$(terraform output -raw prometheus_service_name)\\`"
            echo "- **Grafana Service**: \\`$(terraform output -raw grafana_service_name)\\`"
            echo "- **CloudFront Domain**: \\`$(terraform output -raw cloudfront_domain_name)\\`"
          } >> "$GITHUB_STEP_SUMMARY"
