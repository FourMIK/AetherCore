name: AetherCore MonoRepo CI

on:
  push:
    branches: [main, develop, internal]
  pull_request:
    branches: [main, develop, internal]

jobs:
  network-prerequisites:
    name: Validate Runner Network Prerequisites
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required network endpoints
        run: ./scripts/check-network-prereqs.sh

  verify-documentation:
    needs: [network-prerequisites]
    name: Verify Documentation Completeness
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run documentation verification
        run: |
          chmod +x scripts/verify-docs.sh
          ./scripts/verify-docs.sh

  verify-structure:
    needs: [network-prerequisites]
    name: Verify MonoRepo Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run verification script
        run: |
          chmod +x verify-monorepo.sh
          ./verify-monorepo.sh


  compose-local-smoke:
    needs: [network-prerequisites]
    name: Compose Local Stack Smoke (Backend CONNECTED)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run compose smoke check (no endpoint overrides)
        run: ./scripts/compose-smoke-connected.sh

  rust-workspace:
    needs: [network-prerequisites]
    name: Rust Workspace
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            pkg-config

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/release
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-
            ${{ runner.os }}-cargo-

      - name: Check Rust workspace
        run: cargo check --workspace

      - name: Run Rust tests
        run: cargo test --workspace

      - name: Signature verification regression gate
        run: cargo test -p aethercore-c2-router signature_verification

      - name: Run Clippy
        run: cargo clippy --workspace -- -D warnings

  license-compliance:
    needs: [network-prerequisites]
    name: 'Operation Legal Shield: License Compliance'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo-deny license check
        run: |
          echo "ðŸ›¡ï¸  Operation Legal Shield: Enforcing license compliance"
          cargo deny check licenses

      - name: Run cargo-deny advisories check
        run: cargo deny check advisories

      - name: Run cargo-deny bans check
        run: cargo deny check bans

      - name: Verify deny.toml exists
        run: |
          if [ ! -f "deny.toml" ]; then
            echo "âŒ deny.toml configuration not found"
            exit 1
          fi
          echo "âœ… License compliance configuration verified"

  typescript-workspace:
    needs: [network-prerequisites]
    name: TypeScript Workspace
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run environment checks
        run: pnpm doctor

      - name: Build all packages and services
        run: pnpm run build

      - name: Run tests
        run: pnpm run test

  legacy-isolation:
    needs: [network-prerequisites]
    name: Check Legacy Isolation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for illegal legacy imports
        run: |
          echo "Checking for illegal imports from /legacy..."

          # Search for legacy imports in non-allowed locations
          # Allowed: crates/h2-domain and packages/h2-glass

          VIOLATIONS=0

          # Check Rust files (excluding h2-domain)
          for file in $(find crates -name "*.rs" | grep -v "h2-domain"); do
            if grep -l "legacy" "$file" 2>/dev/null; then
              echo "::error file=$file::Illegal reference to /legacy in $file"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          # Check TypeScript files (excluding h2-glass)
          for file in $(find services packages -name "*.ts" | grep -v "h2-glass"); do
            if grep -l "legacy" "$file" 2>/dev/null; then
              echo "::error file=$file::Illegal reference to /legacy in $file"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS file(s) with illegal legacy references"
            exit 1
          else
            echo "âœ“ No illegal legacy imports found"
          fi

  check-workspace-config:
    needs: [network-prerequisites]
    name: Validate Workspace Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Cargo.toml workspace members
        run: |
          echo "Verifying all crates are in Cargo.toml workspace..."

          MISSING=0
          CRATES=("core" "crypto" "identity" "domain" "mesh" "stream" "edge" "isr" "rf" "radio" "trust_mesh" "h2-domain")

          for crate in "${CRATES[@]}"; do
            if ! grep -q "\"crates/$crate\"" Cargo.toml; then
              echo "::error::Crate crates/$crate not found in workspace members"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            exit 1
          fi

          echo "âœ“ All crates are in workspace"

      - name: Check package.json workspace members
        run: |
          echo "Verifying all services and packages are in package.json workspace..."

          # This is a basic check - in production you'd parse JSON properly
          if ! grep -q '"services/\*"' package.json; then
            echo "::error::services/* not found in workspaces"
            exit 1
          fi

          if ! grep -q '"packages/\*"' package.json; then
            echo "::error::packages/* not found in workspaces"
            exit 1
          fi

          echo "âœ“ Workspace configuration is valid"


  docker-build-smoke:
    needs: [network-prerequisites]
    name: Docker Build Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images from clean checkout
        run: |
          docker build -f infra/docker/Dockerfile.auth -t aethercore-auth-ci .
          docker build -f infra/docker/Dockerfile.gateway -t aethercore-gateway-ci .
          docker build -f infra/docker/Dockerfile.collaboration -t aethercore-collaboration-ci .
          docker build -f infra/docker/Dockerfile.c2-router-mock -t aethercore-c2-router-mock-ci .
          docker build -f services/h2-ingest/Dockerfile -t aethercore-h2-ingest-ci .

  build-and-push-internal:
    name: Build and Push Docker Images (Internal)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/internal'
    needs: [network-prerequisites, rust-workspace, typescript-workspace, license-compliance, docker-build-smoke]
    permissions:
      contents: read
      id-token: write # For OIDC authentication with AWS
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push h2-ingest
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/h2-ingest/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/aethercore-h2-ingest:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/aethercore-h2-ingest:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/Dockerfile.gateway
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/aethercore-gateway:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/aethercore-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push auth
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/Dockerfile.auth
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/aethercore-auth:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/aethercore-auth:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push collaboration
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infra/docker/Dockerfile.collaboration
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/aethercore-collaboration:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/aethercore-collaboration:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    needs: [verify-documentation, rust-workspace, typescript-workspace, license-compliance]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-latest'
            os: ubuntu-latest
            artifact: 'aethercore-tactical-glass_*_amd64.AppImage'
          - platform: 'macos-latest'
            os: macos-latest
            artifact: 'aethercore-tactical-glass_*.dmg'
          - platform: 'windows-latest'
            os: windows-latest
            artifact: 'aethercore-tactical-glass_*.msi'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # macOS dependencies are typically pre-installed
          echo "macOS dependencies check..."

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-desktop-${{ hashFiles('**/Cargo.lock') }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install npm dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Tauri CLI
        run: |
          cd packages/dashboard
          pnpm add -D @tauri-apps/cli@2.9.6

      - name: Build Dashboard TypeScript
        run: |
          cd packages/dashboard
          pnpm run build

      - name: Build Tauri App
        run: |
          cd packages/dashboard
          pnpm tauri build

      - name: Validation Gate (macOS): install + smoke-launch package
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail
          dmg="$(find packages/dashboard/src-tauri/target/release/bundle -name '*.dmg' | head -n 1)"
          mount_dir="$(mktemp -d)"
          hdiutil attach "$dmg" -mountpoint "$mount_dir"
          app_path="$(find "$mount_dir" -maxdepth 1 -name '*.app' | head -n 1)"
          cp -R "$app_path" /Applications/
          hdiutil detach "$mount_dir"

          app_bin="/Applications/$(basename "$app_path")/Contents/MacOS/$(basename "$app_path" .app)"
          CI=1 AETHERCORE_SKIP_SENTINEL_FOR_CI=1 "$app_bin" --bootstrap > /tmp/aethercore-ci-macos.log 2>&1 &
          app_pid=$!
          sleep 20
          kill "$app_pid" || true

      - name: Validation Gate (Windows): install + smoke-launch package
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "packages/dashboard/src-tauri/target/release/bundle" -Recurse -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "No MSI artifact found" }

          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /norestart" -Wait -NoNewWindow

          $exe = Get-ChildItem -Path "$env:LOCALAPPDATA\Programs" -Recurse -Filter "*.exe" |
            Where-Object { $_.Name -like "*Tactical*" -or $_.Name -like "*aethercore*" } |
            Select-Object -First 1
          if (-not $exe) { throw "Installed executable not found" }

          $launch = Start-Process -FilePath $exe.FullName -ArgumentList "--bootstrap" -PassThru -Environment @{
            CI = '1'
            AETHERCORE_SKIP_SENTINEL_FOR_CI = '1'
          }
          Start-Sleep -Seconds 20
          if (-not $launch.HasExited) { Stop-Process -Id $launch.Id -Force }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tactical-glass-${{ matrix.platform }}
          path: |
            packages/dashboard/src-tauri/target/release/bundle/*/*.AppImage
            packages/dashboard/src-tauri/target/release/bundle/*/*.dmg
            packages/dashboard/src-tauri/target/release/bundle/*/*.msi

  build-arm-edge:
    name: Build ARM64 Edge Library
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    needs: [rust-workspace]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build ARM64 Edge Library
        run: |
          chmod +x scripts/build_arm.sh
          ./scripts/build_arm.sh

      - name: Upload ARM64 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aethercore-edge-arm64
          path: target/aarch64-unknown-linux-gnu/release/libaethercore_edge.rlib
